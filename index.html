<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onda Verde AI - Voice Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    <style>
        :root { --primary: #28a745; --warning: #ffc107; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 400px; }
        .card { background: var(--card); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); text-align: center; border: 1px solid #333; }
        .vel-alvo { font-size: 5.5rem; font-weight: 900; color: var(--primary); margin: 5px 0; text-shadow: 0 0 20px rgba(40, 167, 69, 0.3); }
        .label-km { color: #888; letter-spacing: 2px; font-size: 0.9rem; margin-bottom: 20px; }
        select, input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 1rem; }
        button { width: 100%; padding: 16px; margin: 8px 0; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-green { background: var(--primary); color: white; height: 80px; font-size: 1.3rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); }
        .btn-save { background: #444; color: white; }
        .btn-reset { background: var(--warning); color: #000; }
        .status { color: #aaa; font-size: 0.85rem; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; min-height: 20px; }
        .dist-info { font-size: 1.1rem; color: #007bff; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin-top: 0;">Onda Verde AI</h2>
        <div id="distancia-display" class="dist-info">Distância: -- m</div>
        <div class="vel-alvo" id="vel-alvo">0</div>
        <div class="label-km">KM/H RECOMENDADOS</div>

        <select id="lista-farois" onchange="selecionarFarol(this.value)">
            <option value="">Localizando faróis...</option>
        </select>
        
        <button class="btn-save" onclick="salvarFarol()">+ SALVAR LOCAL ATUAL</button>
        
        <hr style="border: 0.5px solid #333; margin: 20px 0;">

        <label style="font-size: 0.9rem; color: #bbb;">Tempo do Ciclo (s):</label>
        <input type="number" id="tempo-ciclo" value="30">
        
        <button class="btn-green" id="btn-start" onclick="iniciarOnda()">PARTIR AGORA!</button>
        <button class="btn-reset" onclick="resetarCiclo()">REINICIAR CICLO</button>
        
        <div class="status" id="status">Aguardando comando...</div>
    </div>
</div>

<script>
    let listaFarois = JSON.parse(localStorage.getItem('meusFarois')) || [];
    let destino = null;
    let watchId = null;
    let timerCronometro = null;
    let tempoAtual = 0;
    let ultimaVoz = 0; // Para controlar o intervalo da voz
    const noSleep = new NoSleep();

    // Inicialização
    organizarListaPorProximidade();
    setInterval(organizarListaPorProximidade, 10000); // Reorganiza a cada 10s

    // --- FUNÇÃO DE VOZ ---
    function falar(texto) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- SALVAR FAROL (CORRIGIDO) ---
    function salvarFarol() {
        document.getElementById('status').innerText = "Obtendo GPS preciso...";
        
        navigator.geolocation.getCurrentPosition(pos => {
            const nome = prompt("Nome do cruzamento/farol:");
            if (!nome) return;

            const novoFarol = {
                nome: nome,
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
            };

            listaFarois.push(novoFarol);
            localStorage.setItem('meusFarois', JSON.stringify(listaFarois));
            document.getElementById('status').innerText = "Farol '" + nome + "' salvo!";
            organizarListaPorProximidade();
        }, err => {
            alert("Erro GPS: " + err.message);
        }, { enableHighAccuracy: true, timeout: 5000 });
    }

    function organizarListaPorProximidade() {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            listaFarois.forEach(f => {
                f.distTemp = calcularDistancia(lat, lon, f.lat, f.lon);
            });

            listaFarois.sort((a, b) => a.distTemp - b.distTemp);
            atualizarSelect();
        }, null, { enableHighAccuracy: true });
    }

    function atualizarSelect() {
        const select = document.getElementById('lista-farois');
        select.innerHTML = '<option value="">Selecione um Farol</option>';
        listaFarois.forEach((f, i) => { 
            const dist = f.distTemp ? `(${(f.distTemp/1000).toFixed(2)}km)` : "";
            select.innerHTML += `<option value="${i}">${f.nome} ${dist}</option>`; 
        });
    }

    function selecionarFarol(i) {
        destino = listaFarois[i] || null;
        if(destino) document.getElementById('status').innerText = "Destino: " + destino.nome;
    }

    function resetarCiclo() {
        tempoAtual = parseInt(document.getElementById('tempo-ciclo').value);
        falar("Ciclo reiniciado");
    }

    // --- LÓGICA PRINCIPAL (watchPosition) ---
    function iniciarOnda() {
        if (!destino) return alert("Selecione um farol na lista!");
        
        noSleep.enable();
        falar("Iniciando onda verde. Siga a velocidade indicada.");
        
        tempoAtual = parseInt(document.getElementById('tempo-ciclo').value);
        if (watchId) navigator.geolocation.clearWatch(watchId);
        if (timerCronometro) clearInterval(timerCronometro);

        // Cronômetro regressivo
        timerCronometro = setInterval(() => {
            if (tempoAtual > 0) tempoAtual--;
        }, 1000);

        // Rastreamento contínuo
        watchId = navigator.geolocation.watchPosition(pos => {
            const d = calcularDistancia(pos.coords.latitude, pos.coords.longitude, destino.lat, destino.lon);
            document.getElementById('distancia-display').innerText = `Distância: ${Math.round(d)} m`;

            if (tempoAtual > 0 && d > 10) {
                let vKmh = ((d / tempoAtual) * 3.6).toFixed(1);
                
                // Atualiza tela
                if (vKmh > 110) {
                    document.getElementById('vel-alvo').innerText = "---";
                    document.getElementById('status').innerText = "Muito longe!";
                } else {
                    document.getElementById('vel-alvo').innerText = vKmh;
                    document.getElementById('status').innerText = `T: ${tempoAtual}s | SINAL OK`;
                    
                    // Alerta de voz a cada 10 segundos para não irritar
                    if (Date.now() - ultimaVoz > 10000) {
                        falar(`Velocidade ideal ${Math.round(vKmh)}`);
                        ultimaVoz = Date.now();
                    }
                }
            } else if (d <= 10) {
                document.getElementById('vel-alvo').innerText = "OK";
                document.getElementById('status').innerText = "Você chegou!";
                falar("Você chegou ao destino.");
                pararTudo();
            }
        }, err => {
            document.getElementById('status').innerText = "Erro GPS: " + err.message;
        }, { enableHighAccuracy: true, maximumAge: 0 });
    }

    function pararTudo() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        if (timerCronometro) clearInterval(timerCronometro);
        noSleep.disable();
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // Detectar retorno à aba
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && watchId) {
            organizarListaPorProximidade();
        }
    });
</script>

</body>
</html>
