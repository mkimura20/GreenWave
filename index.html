<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onda Verde AI - Auto-Drive Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #28a745; --warning: #ffc107; --danger: #dc3545; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; overflow-x: hidden; }
        .container { width: 100%; max-width: 450px; }
        .card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; }
        
        .vel-alvo { font-size: 5.5rem; font-weight: 900; color: var(--primary); margin: 0; line-height: 1; }
        
        .progress-container { width: 100%; height: 12px; background: #333; border-radius: 6px; margin: 15px 0; overflow: hidden; border: 1px solid #444; }
        .progress-bar { height: 100%; width: 0%; transition: width 0.3s linear, background-color 0.5s; }

        .auto-status { font-size: 0.7rem; color: #28a745; margin-bottom: 5px; font-weight: bold; display: none; }

        #map { height: 150px; width: 100%; border-radius: 15px; margin: 10px 0; border: 1px solid #333; }
        
        .inputs-ciclo { display: flex; gap: 8px; justify-content: center; margin: 10px 0; }
        .inputs-ciclo div { display: flex; flex-direction: column; font-size: 0.75rem; color: #bbb; }
        input, select { padding: 8px; border-radius: 8px; border: 1px solid #444; background: #2a2a2a; color: white; text-align: center; font-size: 0.9rem; }
        
        button { width: 100%; padding: 12px; margin: 4px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-green { background: var(--primary); color: white; height: 55px; }
        .btn-sync { background: var(--warning); color: #000; }
        .btn-fino { background: #333; color: white; width: 45px; padding: 8px; }
        .status { color: #888; font-size: 0.75rem; margin-top: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div id="auto-msg" class="auto-status">● MODO AUTO-TRAJETO ATIVO</div>
        <div id="distancia-display" style="font-weight: bold; color: #007bff; font-size: 0.9rem;">À PROCURA DE FARÓIS...</div>
        
        <div class="vel-alvo" id="vel-alvo">0</div>
        
        <div class="progress-container">
            <div id="barra-ciclo" class="progress-bar"></div>
        </div>

        <div id="fase-label" style="font-weight: bold; font-size: 0.8rem;">SINCRONIA INTELIGENTE</div>

        <div id="map"></div>

        <select id="lista-farois" onchange="selecionarFarolManual(this.value)" style="width: 100%; margin-bottom: 5px;">
            <option value="">A carregar base de dados...</option>
        </select>

        <div class="inputs-ciclo">
            <div> Verde(s) <input type="number" id="t-verde" value="30"> </div>
            <div> Verm(s) <input type="number" id="t-vermelho" value="30"> </div>
            <div> Buffer(s) <input type="number" id="t-buffer" value="2"> </div>
        </div>

        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 5px;">
            <button class="btn-fino" onclick="ajusteFino(-1000)">-1s</button>
            <button class="btn-sync" style="flex-grow: 1;" onclick="sincronizarAgora()">SINCRONIZAR ABERTURA</button>
            <button class="btn-fino" onclick="ajusteFino(1000)">+1s</button>
        </div>
        
        <button class="btn-green" id="btn-master" onclick="toggleMonitoramento()">ATIVAR MONITORIZAÇÃO</button>
        
        <div class="status" id="status">O app seleciona o próximo farol automaticamente.</div>
    </div>
</div>

<script>
    let listaFarois = JSON.parse(localStorage.getItem('meusFarois')) || [];
    let destino = null, watchId = null, mapa, marcadorUser, marcadorFarol;
    let ultimaVoz = 0, monitorando = false;
    const noSleep = new NoSleep();

    // Inicialização do Mapa
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        mapa = L.map('map').setView([lat, lon], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
        marcadorUser = L.marker([lat, lon]).addTo(mapa);
        atualizarSelect();
    }, null, { enableHighAccuracy: true });

    function falar(texto) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(texto);
            u.lang = 'pt-PT';
            window.speechSynthesis.speak(u);
        }
    }

    function atualizarSelect() {
        const select = document.getElementById('lista-farois');
        select.innerHTML = '<option value="">Faróis Guardados</option>';
        listaFarois.forEach((f, i) => {
            select.innerHTML += `<option value="${i}">${f.nome}</option>`;
        });
    }

    function selecionarFarolManual(i) {
        if (i === "") return;
        destino = listaFarois[i];
        carregarDadosDestino();
    }

    function carregarDadosDestino() {
        if (!destino) return;
        document.getElementById('t-verde').value = destino.tVerde || 30;
        document.getElementById('t-vermelho').value = destino.tVermelho || 30;
        if (marcadorFarol) mapa.removeLayer(marcadorFarol);
        marcadorFarol = L.circle([destino.lat, destino.lon], { color: 'red', radius: 25 }).addTo(mapa);
        mapa.panTo([destino.lat, destino.lon]);
        document.getElementById('auto-msg').innerText = `● SELECIONADO: ${destino.nome.toUpperCase()}`;
        document.getElementById('auto-msg').style.display = 'block';
    }

    function sincronizarAgora() {
        if (!destino) return alert("Selecione um farol!");
        destino.refSync = Date.now();
        salvarNoStorage();
        falar("Sincronia guardada.");
    }

    function ajusteFino(ms) {
        if (destino && destino.refSync) {
            destino.refSync += ms;
            salvarNoStorage();
        }
    }

    function salvarNoStorage() {
        localStorage.setItem('meusFarois', JSON.stringify(listaFarois));
    }

    function toggleMonitoramento() {
        if (monitorando) {
            navigator.geolocation.clearWatch(watchId);
            monitorando = false;
            document.getElementById('btn-master').innerText = "ATIVAR MONITORIZAÇÃO";
            document.getElementById('btn-master').style.background = "var(--primary)";
            noSleep.disable();
        } else {
            monitorando = true;
            document.getElementById('btn-master').innerText = "PARAR MONITORIZAÇÃO";
            document.getElementById('btn-master').style.background = "var(--danger)";
            noSleep.enable();
            iniciarGPS();
        }
    }

    function iniciarGPS() {
        watchId = navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude, lon = pos.coords.longitude;
            marcadorUser.setLatLng([lat, lon]);

            // LÓGICA DE CARREGAMENTO AUTOMÁTICO
            // Se não temos destino ou o destino atual está longe (>800m), procura o mais próximo à frente
            if (!destino || calcularDistancia(lat, lon, destino.lat, destino.lon) > 800) {
                encontrarProximoFarolNoTrajeto(lat, lon);
            }

            if (destino) {
                const d = calcularDistancia(lat, lon, destino.lat, destino.lon);
                document.getElementById('distancia-display').innerText = `${destino.nome.toUpperCase()} • ${Math.round(d)}M`;

                // Se passou pelo farol (<15m), limpa para procurar o próximo
                if (d < 15) {
                    falar("Passou por " + destino.nome);
                    destino = null;
                    return;
                }

                processarCalculosOnda(d);
            }
        }, null, { enableHighAccuracy: true });
    }

    function encontrarProximoFarolNoTrajeto(lat, lon) {
        let candidatos = listaFarois.map(f => ({
            ...f,
            dist: calcularDistancia(lat, lon, f.lat, f.lon)
        }));

        // Filtra faróis num raio de 800m
        candidatos = candidatos.filter(c => c.dist < 800);
        candidatos.sort((a, b) => a.dist - b.dist);

        if (candidatos.length > 0) {
            destino = candidatos[0];
            carregarDadosDestino();
            falar("A aproximar de " + destino.nome);
        }
    }

    function processarCalculosOnda(distancia) {
        const tV = parseInt(document.getElementById('t-verde').value) * 1000;
        const tR = parseInt(document.getElementById('t-vermelho').value) * 1000;
        const tBuffer = parseInt(document.getElementById('t-buffer').value) * 1000;
        const cicloTotal = tV + tR;
        
        const ref = destino.refSync || Date.now();
        let tempoRelativo = (Date.now() - ref) % cicloTotal;
        if (tempoRelativo < 0) tempoRelativo += cicloTotal;

        const barra = document.getElementById('barra-ciclo');
        let tempoAlvo, modo, percent;

        if (tempoRelativo < tV) {
            tempoAlvo = (tV - tempoRelativo) / 1000;
            modo = "VERDE";
            percent = (1 - (tempoRelativo / tV)) * 100;
            barra.style.backgroundColor = "var(--primary)";
        } else {
            tempoAlvo = ((cicloTotal - tempoRelativo) + tBuffer) / 1000;
            modo = "VERMELHO";
            percent = ((tempoRelativo - tV) / tR) * 100;
            barra.style.backgroundColor = "var(--warning)";
        }

        barra.style.width = percent + "%";
        const velDisplay = document.getElementById('vel-alvo');
        const faseLabel = document.getElementById('fase-label');
        
        let vKmh = ((distancia / tempoAlvo) * 3.6).toFixed(1);
        velDisplay.innerText = vKmh > 125 ? "---" : vKmh;
        velDisplay.style.color = (modo === "VERDE") ? "var(--primary)" : "var(--warning)";
        faseLabel.innerText = `${modo} • ${Math.round(tempoAlvo)}s`;
        faseLabel.style.color = velDisplay.style.color;

        if (Date.now() - ultimaVoz > 15000 && vKmh <= 125 && vKmh > 10) {
            falar(`Mantenha ${Math.round(vKmh)}`);
            ultimaVoz = Date.now();
        }
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180, dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
</script>
</body>
</html>
