<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onda Verde AI - Pro Version</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #28a745; --danger: #dc3545; --bg: #121212; --card: #1e1e1e; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .container { width: 100%; max-width: 450px; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; }
        
        .vel-alvo { font-size: 5rem; font-weight: 900; color: var(--primary); margin: 0; }
        .dist-info { font-size: 1.1rem; color: #007bff; font-weight: bold; margin-bottom: 5px; }
        
        #map { height: 220px; width: 100%; border-radius: 15px; margin: 15px 0; border: 1px solid #333; z-index: 1; }

        select, input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 1rem; }
        button { width: 100%; padding: 15px; margin: 5px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        .btn-green { background: var(--primary); color: white; height: 70px; font-size: 1.2rem; }
        .btn-save { background: #444; color: white; }
        .btn-delete { background: var(--danger); color: white; font-size: 0.8rem; padding: 10px; margin-bottom: 10px; }
        .btn-reset { background: #ffc107; color: #000; }
        
        .status { color: #aaa; font-size: 0.8rem; margin-top: 10px; min-height: 20px; background: rgba(0,0,0,0.2); border-radius: 5px; padding: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin: 0 0 10px 0;">Onda Verde AI</h2>
        
        <div id="distancia-display" class="dist-info">Aguardando GPS...</div>
        <div class="vel-alvo" id="vel-alvo">0</div>
        <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">KM/H RECOMENDADOS</div>

        <div id="map"></div>

        <select id="lista-farois" onchange="selecionarFarol(this.value)">
            <option value="">Localizando pontos próximos...</option>
        </select>
        
        <button class="btn-save" onclick="salvarFarol()">+ SALVAR LOCAL ATUAL</button>
        <button class="btn-delete" onclick="eliminarFarol()">LIMPAR PONTO SELECIONADO</button>
        
        <hr style="border: 0.5px solid #333; margin: 15px 0;">

        <div style="display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 10px;">
            <label>Ciclo (s):</label>
            <input type="number" id="tempo-ciclo" value="30" style="width: 80px;">
        </div>
        
        <button class="btn-green" onclick="iniciarOnda()">PARTIR AGORA!</button>
        <button class="btn-reset" onclick="resetarCiclo()">REINICIAR TEMPO</button>
        
        <div class="status" id="status">Selecione um ponto e clique em Partir.</div>
    </div>
</div>

<script>
    let listaFarois = JSON.parse(localStorage.getItem('meusFarois')) || [];
    let destino = null;
    let watchId = null;
    let horaFinalEsperada = 0;
    let ultimaVoz = 0;
    let mapa, marcadorUser, marcadorFarol;
    const noSleep = new NoSleep();

    // Iniciar GPS para o mapa e organização
    navigator.geolocation.getCurrentPosition(pos => {
        atualizarMapa(pos.coords.latitude, pos.coords.longitude);
        organizarListaPorProximidade();
    }, err => {
        document.getElementById('status').innerText = "Erro GPS: " + err.message;
    }, { enableHighAccuracy: true });

    // Atualiza a cada 10s para manter a lista ordenada conforme você se move
    setInterval(organizarListaPorProximidade, 10000);

    function falar(texto) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // Para falas anteriores
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'pt-BR';
            window.speechSynthesis.speak(utterance);
        }
    }

    function atualizarMapa(lat, lon) {
        if (!mapa) {
            mapa = L.map('map').setView([lat, lon], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
            marcadorUser = L.marker([lat, lon]).addTo(mapa).bindPopup("Você");
        } else {
            marcadorUser.setLatLng([lat, lon]);
            if (!destino) mapa.panTo([lat, lon]);
        }
    }

    function salvarFarol() {
        navigator.geolocation.getCurrentPosition(pos => {
            const nome = prompt("Nome do ponto:");
            if (!nome) return;
            listaFarois.push({ nome, lat: pos.coords.latitude, lon: pos.coords.longitude });
            localStorage.setItem('meusFarois', JSON.stringify(listaFarois));
            organizarListaPorProximidade();
            document.getElementById('status').innerText = "Ponto salvo!";
        }, null, { enableHighAccuracy: true });
    }

    function eliminarFarol() {
        const select = document.getElementById('lista-farois');
        const index = select.value;
        if (index === "" || !confirm("Deseja apagar este ponto permanentemente?")) return;
        
        listaFarois.splice(index, 1);
        localStorage.setItem('meusFarois', JSON.stringify(listaFarois));
        destino = null;
        if (marcadorFarol) mapa.removeLayer(marcadorFarol);
        organizarListaPorProximidade();
        document.getElementById('status').innerText = "Ponto removido.";
    }

    function organizarListaPorProximidade() {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            listaFarois.forEach(f => {
                f.distTemp = calcularDistancia(lat, lon, f.lat, f.lon);
            });
            listaFarois.sort((a, b) => a.distTemp - b.distTemp);
            atualizarSelect();
            atualizarMapa(lat, lon);
        }, null, { enableHighAccuracy: true });
    }

    function atualizarSelect() {
        const select = document.getElementById('lista-farois');
        select.innerHTML = '<option value="">Selecione um Ponto</option>';
        listaFarois.forEach((f, i) => { 
            const dist = f.distTemp ? `(${(f.distTemp/1000).toFixed(2)}km)` : "";
            select.innerHTML += `<option value="${i}">${f.nome} ${dist}</option>`; 
        });
    }

    function selecionarFarol(i) {
        destino = listaFarois[i] || null;
        if (destino) {
            if (marcadorFarol) mapa.removeLayer(marcadorFarol);
            marcadorFarol = L.circle([destino.lat, destino.lon], { color: 'red', radius: 20 }).addTo(mapa);
            mapa.panTo([destino.lat, destino.lon]);
        }
    }

    function resetarCiclo() {
        const segundos = parseInt(document.getElementById('tempo-ciclo').value);
        horaFinalEsperada = Date.now() + (segundos * 1000);
        falar("Reiniciado");
    }

    function iniciarOnda() {
        if (!destino) return alert("Selecione um ponto primeiro!");
        noSleep.enable();
        
        const segundos = parseInt(document.getElementById('tempo-ciclo').value);
        horaFinalEsperada = Date.now() + (segundos * 1000);

        if (watchId) navigator.geolocation.clearWatch(watchId);

        watchId = navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            atualizarMapa(lat, lon);
            
            const d = calcularDistancia(lat, lon, destino.lat, destino.lon);
            document.getElementById('distancia-display').innerText = `Distância: ${Math.round(d)} m`;

            let tempoRestante = Math.max(0, (horaFinalEsperada - Date.now()) / 1000);

            if (tempoRestante > 0 && d > 10) {
                let vKmh = ((d / tempoRestante) * 3.6).toFixed(1);
                document.getElementById('vel-alvo').innerText = vKmh > 120 ? "---" : vKmh;
                document.getElementById('status').innerText = `Tempo: ${Math.round(tempoRestante)}s | GPS Ativo`;

                if (Date.now() - ultimaVoz > 12000 && vKmh <= 120) {
                    falar(`Velocidade ${Math.round(vKmh)}`);
                    ultimaVoz = Date.now();
                }
            } else if (d <= 10) {
                document.getElementById('vel-alvo').innerText = "OK";
                falar("Chegou!");
                pararTudo();
            } else {
                document.getElementById('vel-alvo').innerText = "---";
                document.getElementById('status').innerText = "Tempo esgotado!";
            }
        }, err => {
            document.getElementById('status').innerText = "Erro GPS: " + err.message;
        }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    }

    function pararTudo() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        noSleep.disable();
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
</script>
</body>
</html>
